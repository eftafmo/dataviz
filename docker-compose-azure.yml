version: '2'
services:
  solr:
    image: solr:6.6.4
    user: root
    environment:
      - TZ=Europe/Brussels
      - SOLR_HOME=/solr_home
      - SOLR_HEAP=256m
      - SOLR_TIMEZONE=CET
      - SOLR_LOG_LEVEL=CONFIG
      - SOLR_LOGS_DIR=/solr_logs
      - INIT_SOLR_HOME=yes
      # LOG4J_PROPS=/var/solr/log4j.properties
    volumes:
      - solrhome:/solr_home
      - solrlogs:/solr_logs
    restart: "always"


  web:
    image: eftafmo/dataviz:latest
    environment:
      - NUM_WORKERS=3
    env_file:
      - docker/web.env
    volumes:
      - weblogs:/var/local/logs
      - webdb:/var/local/db
      - webroot:/var/local/webroot
    restart: "always"

  nginx:
    domainname: eeagstaging
    image: nginx:1.13-alpine
    depends_on:
    - web
    volumes:
    - webroot:/var/local/webroot:ro
    - nginxconfig:/etc/nginx/conf.d:ro
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 100M
    restart: "always"
    command: ["sh", "-c", "set -x; until grep -q web /etc/hosts; do sleep 1; done; exec nginx -g 'daemon off;'"]
    ports:
      - 80:80

volumes:
  webroot:
    driver: azure_file
    driver_opts:
      share_name: webroot
      storage_account_name: eeagstorage
  webdb:
    driver: azure_file
    driver_opts:
      share_name: webdb
      storage_account_name: eeagstorage
  weblogs:
    driver: azure_file
    driver_opts:
      share_name: weblogs
      storage_account_name: eeagstorage
  solrhome:
    driver: azure_file
    driver_opts:
      share_name: solrhome
      storage_account_name: eeagstorage
  solrlogs:
    driver: azure_file
    driver_opts:
      share_name: solrlogs
      storage_account_name: eeagstorage
  nginxconfig:
    driver: azure_file
    driver_opts:
      share_name: nginxconfig
      storage_account_name: eeagstorage

{% extends "_layout-sidebar.html" %}

{% load l10n %}
{% load tags %}
{% load humanize %}

{% block top %}
  <div class="search-top">
    <div class="container">
      <div class="search-top-inner">
        <h1 class="page-title">Search</h1>
        <div class="search-form">
          <div class="clearfix">
            <span class="input-box">
              <input type="search" placeholder="Search" class="visible-search-input" autofocus>
            </span>
            <button type="submit" class="btn btn-primary visible-search-submit">Search</button>
          </div>
        <div class="search-tabs visible-checkboxes" id="search-tabs">
          <span class="muted">Search for:</span>
             <input type="radio" name="kind"
                   {% if form.facets.kind.0 == 'Programme' %}checked{% endif %}>
             <label for="programme-tab">Programmes</label>
              <input type="radio" name="kind"
                   {% if form.facets.kind.0 == 'Project'%}checked{% endif %}>
              <label for="project-tab">Projects</label>
              <input type="radio" name="kind"
                   {% if form.facets.kind.0 == 'Organisation'%}checked{% endif %}>
              <label for="organisation-tab">Organisations</label>
            <input type="radio" name="kind"
                   {% if form.facets.kind.0 == 'News'%}checked{% endif %}>
              <label for="news-tab">News</label>
        </div>
        </div>

      </div>
    </div>
  </div>
{% endblock %}

{% block main %}

  <div class="search-results">
    <div class="search-results-header">
      <span class="search-results-count">
        {{ paginator.count }} {{form.facets.kind.0|lower}}{% if form.facets.kind.0 != 'News' %}{{ paginator.count|pluralize}}{% endif %} found
      </span>
      <span class="search-results-options">
        <select name="paginate_by" id="" class="subtle-select main-auto-submit" form="main-search-form">
          {% for page_size in page_sizes %}
            <option
              value="{{ page_size }}"
              {% if page_size == paginator.per_page %}selected{% endif %}
            >
              {{ page_size }} results per page
            </option>
          {% endfor %}
        </select>
        {% if form.facets.kind.0 == 'Programme' %}
          <a rel="nofollow" href="{% url 'frontend:programme_export' %}?{% for item in query.items %}{{ item.0 }}={{ item.1 }}&{% endfor %}">
            Export
          </a>
        {% elif form.facets.kind.0 == 'Project' %}
          <a rel="nofollow" href="{% url 'frontend:project_export' %}?{% for item in query.items %}{{ item.0 }}={{ item.1 }}&{% endfor %}">
            Export
          </a>
        {% elif form.facets.kind.0 == 'Organisation' %}
          <a rel="nofollow" href="{% url 'frontend:organisation_export' %}?{% for item in query.items %}{{ item.0 }}={{ item.1 }}&{% endfor %}">
            Export
          </a>
        {% elif form.facets.kind.0 == 'News' %}
          <a rel="nofollow" href="{% url 'frontend:news_export' %}?{% for item in query.items %}{{ item.0 }}={{ item.1 }}&{% endfor %}">
            Export
          </a>
        {% endif %}
      </span>
    </div>

    <ul class="no-list">
      {% for res in page_obj.object_list %}
      <li class="results-list">
        <div class="search-result search-result-programme">
          <h3 class="title">
            {% if res.url %}
              <a href="{{ res.url }}" target="_blank">{{ res.name }}</a>
            {% else %}
              <span>{{ res.name }}</span>
            {% endif %}
          </h3>
         <p class="description">

          {% if form.facets.kind.0 == 'Programme' %}

            <div class="country_status">
              <span class="country">
              {% for state in res.state_name|sort %}
                <img src="/assets/imgs/flag-{{ state|lower|cut:" " }}.png"
                  alt="{{ state }} flag"
                  height="20px">
                <span>{{ state }}</span>{% if not forloop.last %}, {% endif %}
              {% endfor %}
              </span>
              {% if res.state_name|length == 1 %} | {% else %}<br><b>Status: </b>{% endif %}
              <span title="Programme status">{{ res.programme_status.0 }}</span>
            </div>

            <div>
              <b>Funded by: </b>
              {% for fm in res.financial_mechanism_ss %}
                <span>{{ fm }}</span>{% if not forloop.last %} and {% endif %}
              {% endfor %}
            </div>
            {% with res.priority_sector_ss|length as num_sectors %}
              {% if num_sectors == 1 %}
                <div><b>Sector:</b> <span>{{ res.priority_sector_ss.0 }}</span></div>
                {% with res.programme_area_ss|length as num_areas %}
                <div><b>Programme area{{ num_areas|pluralize }}:</b>
                  {% for pa in res.programme_area_ss %}
                    <span>{{ pa }}</span>{% if not forloop.last %},{% endif %}
                  {% endfor %}
                </div>
                {% endwith %}
              {% else %}
                <div class="search_listing"><b>Sectors | Programme area(s):</b><ul>
                  {% for ps in res.priority_sector_ss %}
                    <li><span title="Sector: {{ ps }}">{{ ps }}</span>
                      {% with res.areas_by_sector|keyvalue:ps as areas %}
                      <ul>
                      {% for pa in areas %}
                        <li>
                        <span title="Programme area: {{ pa }}">{{ pa }}</span>
                        </li>
                      {% endfor %}
                      {% endwith %}
                      </ul>
                    </li>
                  {% endfor %}
                </ul>
                </div>
              {% endif %}

            {% endwith %}
            <div><b>Grant: </b> {{ res.grant | floatformat:0 | currency }}</div>
            <div><b>Case number: </b> {{ res.code }}</div>

          {% elif form.facets.kind.0 == 'Project' %}

            <div class="country_status">
              <span class="country"><img src="/assets/imgs/flag-{{ res.state_name.0|lower|cut:" " }}.png"
                alt="{{ res.state_name.0 }} flag"
                height="20px">&nbsp;{{ res.state_name.0 }}</span> |
              <span>{{ res.project_status.0 }}</span>
            </div>
            <p>
              <div><b>Programme:</b> {{ res.programme_name.0 }}</div>
              <div><b>Funded by :</b> {{ res.financial_mechanism_ss.0 }}</div>
              <div><b>Sector:</b> {{ res.priority_sector_ss.0 }}</div>
              <ul class="search_listing"><li><span>{{ res.programme_area_ss.0 }}</span></li></ul>
              <div><b>Grant:</b> {{ res.grant | floatformat:0 | currency }}</div>
              <div><b>Case number:</b> {{ res.code }}</div>
            </p>

          {% elif form.facets.kind.0 == 'Organisation' %}

            <div class="country_status">
              <span class="country">
              {% if res.country in states_with_flags %}
              <img src="/assets/imgs/flag-{{ res.country|lower|cut:" " }}.png"
                alt="{{ res.country }} flag"
                height="20px">&nbsp;{% endif %}{{ res.country }}</span> |
              <span>{{ res.org_type_category }}</span> |
              <span>{{ res.org_type }}</span>
            </div>


            <div class="search_listing">
              {% for role, plist in res.prep_roles.items %}
                <span>{{ role }} for:</span>
                <ul>
                  {% for p in plist %}
                  <li>{% if p.url %}<a href="{{p.url}}" target="_blank">{{ p.name }}</a>
                      {% else %}<span>{{p.name}}</span>
                      {% endif %}
                  </li>
                  {% endfor %}
                </ul>
              {% endfor %}
            </div>

          {% elif form.facets.kind.0 == 'News' %}
            <div style="column-count: 2">
              <div class="country_status">
                  <span class="country">
                  {% for state in res.state_name %}
                    <img src="/assets/imgs/flag-{{ state|lower|cut:" " }}.png"
                         alt="{{ state }} flag"
                         height="20px">&nbsp;{{ state }}
                {% endfor %}</span>
              </div>
              <div>{{ res.created_dt | date:"d F Y" }}</div>
              <div>{{ res.summary }}</div>
              <img src="{{ res.image }}" style="column-span: 1">
              <p>
                <br>
                <div>
                  <b>Programme:</b>
                  {% if res.programme_name|length == 1 %}
                    {{ res.programme_name.0 }}
                  {% else %}
                    <ul class="search_listing">
                      {% for programme in res.programme_name %}
                        <li><span>{{ programme }}</span></li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                </div>
                {% if res.project_name %}
                  <div><b>Project:</b> {{ res.project_name.0 }}</div>
                  <div><b>Project status:</b> {{ res.project_status.0 }}</div>
                  <div><b>Funded by :</b> {{ res.financial_mechanism_ss.0 }}</div>
                  <div><b>Sector:</b>
                    {% if res.priority_sector_ss|length == 1 %}
                      {{ res.priority_sector_ss.0 }}
                    {% else %}
                      <ul class="search_listing">
                        {% for sector in res.priority_sector_ss %}
                        <li><span>{{ sector }}</span></li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </div>
                {% endif %}
                <div>
                  <b>Programme areas:</b>
                  {% if res.programme_area_ss|length == 1 %}
                    {{ res.programme_area_ss.0 }}
                  {% else %}
                    <ul class="search_listing">
                      {% for area in res.programme_area_ss %}
                        <li><span>{{ area }}</span></li>
                      {% endfor %}
                    </ul>
                  {% endif %}
              </div>
              </p>
            </div>
          {% else %}
            {{ res.text }}
          {% endif %}
        </div>
      </li>
      {% endfor %}
    </ul>


    {% if is_paginated %}
    <div class="search-results-footer">
      <div class="pagination clearfix">
        <button
          class="btn btn-default pagination-previous"
          {% if page_obj.has_previous %}
            name="page"
            value="{{ page_obj.previous_page_number }}"
            type="submit"
            form="main-search-form"
          {% else %}
            disabled="disabled"
          {% endif %}
        > &lt; </button>

        <div class="pagination-pages">
          {% for page_num in paginator.page_range %}
            {% if page_num >= page_obj.number|add:"-1" and page_num <= page_obj.number|add:"1" or page_num == 1 or page_num == paginator.num_pages %}
            <button
              name="page"
              class="btn btn-default"
              value="{{ page_num }}"
              type="submit"
              form="main-search-form"
              {% if page_obj.number == page_num %}
                class="is-current-page"
                disabled="disabled"
              {% endif %}
            >{{ page_num }}</button>
            {% endif %}
          {% endfor %}
        </div>

        <button
          class="btn btn-default pagination-next"
          {% if page_obj.has_next %}
            name="page"
            value="{{ page_obj.next_page_number }}"
            type="submit"
            form="main-search-form"
          {% else %}
            disabled="disabled"
          {% endif %}
        > &gt; </button>

      </div>
    </div>
    {% endif %}

  </div>
{% endblock %}

{% block aside %}
  <sidebar id="sidebar-filters" class="search sidebar-filters">
    <div class="sidebar-header">
      <h3 class="sidebar-title">Search filters</h3>
      <button id="main-reset" class="no-btn small muted" type="reset" form="main-search-form">Reset</button>
    </div>
    <div class="sidebar-body">
    <form class="search-form" id="main-search-form">

      <div class="hidden-form">
          <span class="input-box">
            <input class="hidden-search-input" type="search" placeholder="Search" name="q" autofocus
              value="{{ form.q.data | default_if_none:"" }}">
          </span>
        <button class="hidden-search-submit" type="submit" class="btn btn-primary" name="page" value="1">Search</button>

       <div class="hidden-checkboxes search-tabs" id="search-tabs">
        <input type="radio" name="kind" id="programme-tab" value="Programme"
               {% if form.facets.kind.0 == 'Programme' %}checked{% endif %}>
        <input type="radio" name="kind" id="project-tab" value="Project"
               {% if form.facets.kind.0 == 'Project'%}checked{% endif %}>
        <input type="radio" name="kind" id="organisation-tab" value="Organisation"
               {% if form.facets.kind.0 == 'Organisation'%}checked{% endif %}>
        <input type="radio" name="kind" id="news-tab" value="News"
               {% if form.facets.kind.0 == 'News'%}checked{% endif %}>
      </div>

      </div>
      {% if page_obj.object_list %}
        <!--
        <div class="input-group">
          <div class="input-box input-block">
            <label for="funding-period-facet">Funding period</label>
            <select name="" id="funding-period-facet">
              <option value="">2009 - 2014</option>
            </select>
          </div>
        </div>
        -->

      {% if facets.fields.financial_mechanism_ss %}
      <div class="input-group">
        <div class="input-box input-block">
          <label>Financial mechanism</label>
          <!--select multiple name="" id="financial-mechanism-facet" form="main-search-form" class="main-auto-submit"-->
          {% for o in facets.fields.financial_mechanism_ss %}
            <label class="clearfix checkbox_label">
              <input type="checkbox" name="financial_mechanism_ss" id="fm_{{ forloop.counter }}" value="{{ o.0 }}" {% if o.0 in form.facets.financial_mechanism_ss %}checked{% endif %} class="main-auto-submit" form="main-search-form">
              <label for="fm_{{ forloop.counter }}"></label>
              <span>{{ o.0 }} ({{ o.1 }})</span>
            </label>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if facets.fields.state_name %}
      <div class="input-group">
        <div class="input-box input-block">
          <label for="state-facet">Beneficiary state</label>
          <select multiple name="state_name" id="state-facet" form="main-search-form" class="main-auto-submit">
            {% for o in facets.fields.state_name %}
              {% if o.1 %}
              <option value="{{ o.0 }}" {% if o.0 in form.facets.state_name %}selected{% endif %}>
                {{ o.0 }} ({{ o.1 }})
              </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>
      {% endif %}

      {% if facets.fields.priority_sector_ss %}
      <div class="input-group">
        <div class="input-box input-block">
          <label for="priority-sector-facet">Sector</label>
          <select multiple name="priority_sector_ss" id="priority-sector-facet" form="main-search-form" class="main-auto-submit">
            {% for o in facets.fields.priority_sector_ss %}
              {% if o.1 %}
              <option value="{{ o.0 }}" {% if o.0 in form.facets.priority_sector_ss %}selected{% endif %}>
                {{ o.0 }} ({{ o.1 }})
              </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>
      {% endif %}

      {% if facets.fields.programme_area_ss %}
      <div class="input-group">
        <div class="input-box input-block">
          <label for="programme-area-facet">Programme area</label>
          <select multiple name="programme_area_ss" id="programme-area-facet" form="main-search-form" class="main-auto-submit">
            {% for o in facets.fields.programme_area_ss %}
              {% if o.1 %}
              <option value="{{ o.0 }}" {% if o.0 in form.facets.programme_area_ss %}selected{% endif %}>
                {{ o.0 }} ({{ o.1 }})
              </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="input-group">
        <div class="input-box input-block">
          <label for="programme-name-facet">Programme</label>
          <select multiple name="programme_name" id="programme-name-facet" form="main-search-form" class="main-auto-submit">
            {% for o in facets.fields.programme_name %}
              {% if o.1 %}
              <option value="{{ o.0 }}" {% if o.0 in form.facets.programme_name %}selected{% endif %}>
                {{ o.0 }} ({{ o.1 }})
              </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>
      {% endif %}

      {% if form.facets.kind.0 == 'Programme' or form.facets.kind.0 == 'Project' or form.facets.kind.0 == 'News' %}

      <div class="input-group">
        <div class="input-box input-block">
          <label for="programme-status-facet">Programme status</label>
          <select multiple name="programme_status" id="programme-status-facet" form="main-search-form" class="main-auto-submit">
            {% for o in facets.fields.programme_status %}
              {% if o.1 %}
              <option value="{{ o.0 }}" {% if o.0 in form.facets.programme_status %}selected{% endif %}>
                {{ o.0 }} ({{ o.1 }})
              </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="input-group">
        <div class="input-box input-block">
          <label for="outcome-facet">Outcome</label>
          <select multiple name="outcome_ss" id="outcome-facet" form="main-search-form" class="main-auto-submit">
            {% for o in facets.fields.outcome_ss %}
              {% if o.1 %}
              <option value="{{ o.0 }}" {% if o.0 in form.facets.outcome_ss %}selected{% endif %}>
                {{ o.0 }} ({{ o.1 }})
              </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>

      {% endif %}

      {% if form.facets.kind.0 == 'Project' or form.facets.kind.0 == 'News' %}
        <div class="input-group">
          <div class="input-box input-block">
            <label for="project-status-facet">Project status</label>
            <select multiple name="project_status" id="project-status-facet" form="main-search-form" class="main-auto-submit">
              {% for o in facets.fields.project_status %}
                {% if o.1 %}
                <option value="{{ o.0 }}" {% if o.0 in form.facets.project_status %}selected{% endif %}>
                  {{ o.0 }} ({{ o.1 }})
                </option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="input-group">
          <div class="input-box input-block">
            <label for="project-theme-facet">Project theme</label>
            <select multiple name="theme_ss" id="project-theme-facet" form="main-search-form" class="main-auto-submit">
              {% for o in facets.fields.theme_ss %}
                {% if o.1 %}
                <option value="{{ o.0 }}" {% if o.0 in form.facets.theme_ss %}selected{% endif %}>
                  {{ o.0 }} ({{ o.1 }})
                </option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="input-group">
          <div class="input-box input-block">
            <label for="geotarget-facet">Project region or city</label>
            <select multiple name="geotarget" id="geotarget-facet" form="main-search-form" class="main-auto-submit">
              {% for o in facets.fields.geotarget %}
                {% if o.1 %}
                <option value="{{ o.0 }}" {% if o.0 in form.facets.geotarget %}selected{% endif %}>
                  {{ o.0 }} ({{ o.1 }})
                </option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>

      {% endif %}

      {% if form.facets.kind.0 == 'Organisation' %}

        <div class="input-group">
          <div class="input-box input-block">
            <label for="organisation-project-name-facet">Project</label>
            <select multiple name="project_name" id="organisation-project-name-facet" form="main-search-form" class="main-auto-submit">
              {% for o in form.facets.project_name %}
                <option value="{{ o }}" selected>{{ o }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        {% if facets.fields.country %}
        <div class="input-group">
          <div class="input-box input-block">
            <label for="country-facet">Country</label>
            <select multiple name="country" id="country-facet" form="main-search-form" class="main-auto-submit">
              {% for o in facets.fields.country %}
                {% if o.1 %}
                <option value="{{ o.0 }}" {% if o.0 in form.facets.country %}selected{% endif %}>
                  {{ o.0 }} ({{ o.1 }})
                </option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>
        {% endif %}

        {% if facets.fields.city %}
        <div class="input-group">
          <div class="input-box input-block">
            <label for="city-facet">City</label>
            <select multiple name="city" id="city-facet" form="main-search-form" class="main-auto-submit">
            {% if facets.fields.city|length > 200 %}
                {% for o in form.facets.city %}
                  <option value="{{ o }}" selected>{{ o }}</option>
                {% endfor %}
            {% else %}
              {% for o in facets.fields.city %}
                {% if o.1 %}
                <option value="{{ o.0 }}" {% if o.0 in form.facets.city %}selected{% endif %}>
                  {{ o.0 }} ({{ o.1 }})
                </option>
                {% endif %}
              {% endfor %}
            {% endif %}
            </select>
          </div>
        </div>
        {% endif %}

        <div class="input-group">
          <div class="input-box input-block">
            <label for="geotarget-facet">Target region or city</label>
            <select multiple name="geotarget" id="geotarget-facet" form="main-search-form" class="main-auto-submit">
              {% for o in facets.fields.geotarget %}
                {% if o.1 %}
                <option value="{{ o.0 }}" {% if o.0 in form.facets.geotarget %}selected{% endif %}>
                  {{ o.0 }} ({{ o.1 }})
                </option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>

        {% if facets.fields.org_type_category %}
        <div class="input-group">
          <div class="input-box input-block">
            <label for="org-type-category-facet">Organisation type category</label>
            <select multiple name="org_type_category" id="org-type-category-facet" form="main-search-form" class="main-auto-submit">
              {% for o in facets.fields.org_type_category %}
                {% if o.1 %}
                <option value="{{ o.0 }}" {% if o.0 in form.facets.org_type_category %}selected{% endif %}>
                  {{ o.0 }} ({{ o.1 }})
                </option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>
        {% endif %}

        {% if facets.fields.org_type %}
        <div class="input-group">
          <div class="input-box input-block">
            <label for="org-type-facet">Organisation type</label>
            <select multiple name="org_type" id="org-type-facet" form="main-search-form" class="main-auto-submit">
              {% for o in facets.fields.org_type %}
                {% if o.1 %}
                <option value="{{ o.0 }}" {% if o.0 in form.facets.org_type %}selected{% endif %}>
                  {{ o.0 }} ({{ o.1 }})
                </option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>
        {% endif %}

        {% if facets.fields.role_ss %}
        <div class="input-group">
          <div class="input-box input-block">
            <label for="role-facet">Organisation role</label>
            <select multiple name="role_ss" id="role-facet" form="main-search-form" class="main-auto-submit">
              {% for o in facets.fields.role_ss %}
                {% if o.1 %}
                <option value="{{ o.0 }}" {% if o.0 in form.facets.role_ss %}selected{% endif %}>
                  {{ o.0 }} ({{ o.1 }})
                </option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>
        {% endif %}

      {% endif %}

      {% endif %}
    </form>
    </div>
  </sidebar>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      function select2AjaxFactory(kind, facet) {
        return {
          ajax: {
            url: function(params) {
              var u = '/api/search_' + kind + '_typeahead/?';
              return u + $("#main-search-form").serialize()
            },
            data: function(params) {
              return {
                auto_name: facet,
                auto_value: params.term,
                page: params.page || 1,
              }
            },
            processResults: function(response, params) {
              return {
                results: response.results,
                pagination: response.pagination,
              }
            },
            delay: 300,
          },
        }
      };
      $("#search-tabs").change(function() {
        var selected = $(this).find("input:checked");
        if (selected.length) {
          var action_url = '/search/' + selected.val().toLowerCase() + '/';
          $("#main-search-form").attr("action", action_url);
          $("#main-search-form").submit();
        }
      });

      var all_select2 = [];
      // common
      //all_select2.push($("#financial-mechanism-facet").select2());
      all_select2.push($("#state-facet").select2());
      all_select2.push($("#priority-sector-facet").select2());
      all_select2.push($("#programme-area-facet").select2());
      all_select2.push($("#programme-name-facet").select2());
      all_select2.push($("#programme-status-facet").select2());

      // programme
      {% if form.facets.kind.0 == 'Programme' %}
        all_select2.push($("#outcome-facet").select2());
      {% endif %}

      // project
      {% if form.facets.kind.0 == 'Project' %}
        all_select2.push($("#project-status-facet").select2());
        all_select2.push($("#project-programme-name-facet").select2());
        all_select2.push($("#project-theme-facet").select2());
        all_select2.push($("#outcome-facet").select2());
        all_select2.push($("#geotarget-facet").select2(select2AjaxFactory('project', 'geotarget')));
      {% endif %}

      // organisation
      {% if form.facets.kind.0 == 'Organisation' %}
        all_select2.push($("#organisation-project-status-facet").select2());
        all_select2.push($("#organisation-project-name-facet").select2(select2AjaxFactory('organisation', 'project_name')));
        all_select2.push($("#country-facet").select2());
        {% if facets.fields.city|length > 200 %}
          all_select2.push($("#city-facet").select2(select2AjaxFactory('organisation', 'city')));
        {% else %}
          all_select2.push($("#city-facet").select2());
        {% endif %}
        all_select2.push($("#geotarget-facet").select2(select2AjaxFactory('organisation', 'geotarget')));
        all_select2.push($("#org-type-category-facet").select2());
        all_select2.push($("#org-type-facet").select2());
        all_select2.push($("#role-facet").select2());
      {% endif %}

      // news
      {% if form.facets.kind.0 == 'News' %}
        all_select2.push($("#project-status-facet").select2());
        all_select2.push($("#project-theme-facet").select2());
        all_select2.push($("#outcome-facet").select2());
        all_select2.push($("#geotarget-facet").select2(select2AjaxFactory('news', 'geotarget')));
      {% endif %}

      $(".main-auto-submit").change(function() {
        $("#main-search-form").submit();
      })
      $("#main-reset").click(function () {
        all_select2.forEach(function(e) {
          e.val(null).trigger("change");
        })
      })

    var minimized_elements = $('.truncate');
    var minimize_character_count = 500;

    minimized_elements.each(function(){
        var t = $(this).text();
        if(t.length < minimize_character_count ) return;

        $(this).html(
            t.slice(0,minimize_character_count )+'<span>... </span><a href="#" class="more">More</a>'+
            '<span style="display:none;">'+ t.slice(minimize_character_count ,t.length)+' <a href="#" class="less">Less</a></span>'
        );
    });

    $('a.more', minimized_elements).click(function(event){
      event.preventDefault();
      var $this = $(this);
      $(this).next().animate({ 'height': 'show' }, {
        duration: 300,
          done: function() {
            $this.animate({'width': 'hide'})
            $this.prev().animate({'width': 'hide'})
          }
        });
    });

    $('a.less', minimized_elements).click(function(event){
      event.preventDefault();
      $(this).parent().animate({ 'height': 'hide' }, {
          duration: 300,
          done: function() {
            $(this).prev().animate({'opacity': 'show'},300)
            $(this).prev().prev().animate({'opacity': 'show'},300)
          }
        })
    });

    //Fixing ie form attribute issue
    $visilbe_input = $('.visible-search-input')
    $hidden_input = $('.hidden-search-input');

    //get initial value on page reload
    $visilbe_input.val($hidden_input.val())

    //sync the real input and submit with the fake ones
    $visilbe_input.on('keyup', function(){
      $hidden_input.val($(this).val())
    });

    $('.visible-search-submit').click(function(){
      $('.hidden-search-submit').click()
    })

    $visilbe_input.keyup(function(event){
      if(event.keyCode == 13){
          $('.hidden-search-submit').click();
      }
    });
    // Sync the fake checboxes in the header with the ones in the form
    $visible_checkboxes = $('.visible-checkboxes');
    $hidden_checkboxes = $('.hidden-checkboxes');

    $('.visible-checkboxes label').on('click',function(e){
      e.preventDefault()
      $target = $hidden_checkboxes.find("input#"+$(this).attr('for')+"");
      $target.prop('checked', true);
      var action_url = '/search/' + $target.val().toLowerCase() + '/';
      $("#main-search-form").attr("action", action_url);
       $("#main-search-form").submit();
    })

    });
  </script>
{% endblock %}

{% block finally %}
  <script>
    new search.SearchRoot({
      el: '#sidebar-filters',
    });
  </script>
{% endblock %}
